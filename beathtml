import asyncio
import logging
import random
import sys
import sqlite3
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo

# ==========================================
# 1. –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô –¢–û–ö–ï–ù –û–¢ BOTFATHER
# ==========================================
TOKEN = "8538110472:AAEq2lmcU17ilbREi85b2hTceljPtb2sPlc"

# –°–°–´–õ–ö–ê –ù–ê –¢–í–û–ï WEB-–ü–†–ò–õ–û–ñ–ï–ù–ò–ï (–ü–æ–∫–∞ —Ç—É—Ç –∑–∞–≥–ª—É—à–∫–∞, –ø–æ—Ç–æ–º –ø–æ–º–µ–Ω—è–µ–º –Ω–∞ —Ç–≤–æ—é)
WEB_APP_URL = "https://example.com" 

# ==========================================
# 2. –ë–ê–ó–ê –î–ê–ù–ù–´–• –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê (SQLite3)
# ==========================================
def init_db():
    conn = sqlite3.connect("bot_stats.db")
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            freestyle_interval INTEGER DEFAULT 5,
            challenges_done INTEGER DEFAULT 0,
            words_freestyled INTEGER DEFAULT 0
        )
    ''')
    conn.commit()
    conn.close()

def get_user(user_id):
    conn = sqlite3.connect("bot_stats.db")
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()
    if not user:
        cursor.execute("INSERT INTO users (user_id) VALUES (?)", (user_id,))
        conn.commit()
        user = (user_id, 5, 0, 0)
    conn.close()
    return {"interval": user[1], "challenges": user[2], "words": user[3]}

def update_stat(user_id, field, value):
    conn = sqlite3.connect("bot_stats.db")
    cursor = conn.cursor()
    cursor.execute(f"UPDATE users SET {field} = {field} + ? WHERE user_id = ?", (value, user_id))
    conn.commit()
    conn.close()

def set_interval(user_id, interval):
    conn = sqlite3.connect("bot_stats.db")
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET freestyle_interval = ? WHERE user_id = ?", (interval, user_id))
    conn.commit()
    conn.close()

def get_rank(words_count):
    if words_count < 50: return "–ù–æ–≤–∏—á–æ–∫ —Å FL Studio üë∂"
    elif words_count < 150: return "–õ–æ–∫–∞–ª—å–Ω—ã–π –ú–° üé§"
    elif words_count < 300: return "–£–ª–∏—á–Ω—ã–π –ü–æ—ç—Ç üèô"
    elif words_count < 600: return "–ú–∞—Å—Ç–µ—Ä –§–ª–æ—É üåä"
    else: return "–†—ç–ø-–ë–æ–∂–µ—Å—Ç–≤–æ üëë"

# ==========================================
# 3. –ë–ê–ó–ê –î–ê–ù–ù–´–• –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò
# ==========================================
GENRES = [
    "–ì—Ä–∞–π–º (Grime)", "–ë–µ–π—Å–ª–∞–π–Ω (Bassline)", "UK Drill", "–ú—Ä–∞—á–Ω—ã–π –¢—Ä–∞–ø (Dark Trap)", 
    "–ú–µ–ª–æ–¥–∏—á–Ω—ã–π –†—ç–ø", "–û–ª–¥—Å–∫—É–ª –ë—É–º-–ë—ç–ø", "–§–æ–Ω–∫ (Phonk)", "–î–∂–µ—Ä—Å–∏ –ö–ª–∞–± (Jersey Club)", 
    "UK Garage", "Jungle", "Drum & Bass (D&B)", "UK Funky", "Classic Dubstep", 
    "2-Step Garage", "Afroswing"
]

MOODS = [
    "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ üò°", "–ú—Ä–∞—á–Ω–æ–µ üåë", "–ö–∞—á–∞—é—â–µ–µ (Bouncy) üï∫", "–ö–æ—Å–º–∏—á–µ—Å–∫–æ–µ/–°—Ç—Ä–∞–Ω–Ω–æ–µ üëΩ", 
    "–ú–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω–æ–µ üåß", "–≠–ø–∏—á–Ω–æ–µ üè∞", "–¢—Ä–µ–≤–æ–∂–Ω–æ–µ üëÅ", "–ß–∏–ª–æ–≤–æ–µ (Chill) üõã", 
    "–ù–æ—Å—Ç–∞–ª—å–≥–∏—á–µ—Å–∫–æ–µ üìº", "–ü—Å–∏—Ö–æ–¥–µ–ª–∏—á–µ—Å–∫–æ–µ üåÄ", "–ö–ª—É–±–Ω–æ–µ/–¢–∞–Ω—Ü–µ–≤–∞–ª—å–Ω–æ–µ ü™©"
]

INSTRUMENTS = [
    "–ú—Ä–∞—á–Ω–æ–µ –ø–∏–∞–Ω–∏–Ω–æ üéπ", "–ü–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–π 808-–π –±–∞—Å üîä", "–ê–Ω–∞–ª–æ–≥–æ–≤—ã–π —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä üìª", 
    "–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∞—è –≥–∏—Ç–∞—Ä–∞ üé∏", "–§–ª–µ–π—Ç–∞ üéµ", "–°–∫—Ä–∏–ø–∫–∞ üéª", "–≠–ª–µ–∫—Ç—Ä–æ–≥–∏—Ç–∞—Ä–∞ ‚ö°Ô∏è", 
    "–í–æ–∫–∞–ª—å–Ω—ã–µ —á–æ–ø—ã (–Ω–∞—Ä–µ–∑–∫–∏) üó£", "–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∏ (Bells) üîî", "–°—Ç—Ä–∞–Ω–Ω—ã–π FX –∑–≤—É–∫ üõ∏"
]

CONDITIONS = [
    "–ò—Å–ø–æ–ª—å–∑—É–π —Å–µ–º–ø–ª –≤—ã—Å—Ç—Ä–µ–ª–∞ üî´",
    "–ü–µ—Ä–µ–≥—Ä—É–∑–∏ –±–∞—Å (Distortion) –¥–æ –ø—Ä–µ–¥–µ–ª–∞ üîä",
    "–ù–∞–ø–∏—à–∏ –≥–ª–∞–≤–Ω—É—é –º–µ–ª–æ–¥–∏—é —Ç–æ–ª—å–∫–æ –∏–∑ 3 –Ω–æ—Ç üéπ",
    "–°–¥–µ–ª–∞–π –º–æ—â–Ω—ã–π –≥–ª–∏—Ç—á-—ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ —É–¥–∞—Ä–Ω—ã—Ö üí•",
    "–ò—Å–ø–æ–ª—å–∑—É–π –ª—é–±–æ–π –∑–≤—É–∫ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—É–∫ –∫–ª—é—á–µ–π) üîë",
    "–°–¥–µ–ª–∞–π —è–º—É (breakdown) –≤–æ–æ–±—â–µ –±–µ–∑ —É–¥–∞—Ä–Ω—ã—Ö üï≥",
    "–î–æ–±–∞–≤—å –≤–æ–∫–∞–ª—å–Ω—ã–π —Å—ç–º–ø–ª –Ω–∞ —Ñ–æ–Ω –∏ —Å–∏–ª—å–Ω–æ –∑–∞–Ω–∏–∑—å –µ–º—É –ø–∏—Ç—á üó£",
    "–°–¥–µ–ª–∞–π –±–∏—Ç—Å–≤–∏—Ç—á (—Ä–µ–∑–∫—É—é —Å–º–µ–Ω—É —Ä–∏—Ç–º–∞ –∏–ª–∏ –º–µ–ª–æ–¥–∏–∏) –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ üîÄ",
    "–ò—Å–ø–æ–ª—å–∑—É–π —Å–∞–π–¥—á–µ–π–Ω –Ω–∞ –∫–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Ç –∫–∏–∫–∞ üóú",
    "–°–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã —Ö—ç—Ç—ã (hi-hats) –∏–≥—Ä–∞–ª–∏ –∑–∞–¥–æ–º –Ω–∞–ø–µ—Ä–µ–¥ (Reverse) ‚è™",
    "–°—Ä–µ–∂—å –≤—Å–µ –≤—ã—Å–æ–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ –Ω–∞ 4 —Ç–∞–∫—Ç–∞ (—ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–¥–∏–æ) üìª",
    "–ò—Å–ø–æ–ª—å–∑—É–π –∞–∫–∫–æ—Ä–¥ –∏–∑ 4 –∏ –±–æ–ª–µ–µ –Ω–æ—Ç –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏ üéº",
    "–î–æ–±–∞–≤—å –∑–≤—É–∫ —Å–∏—Ä–µ–Ω—ã –∏–ª–∏ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –º–∏–≥–∞–ª–∫–∏ üö®",
    "–ó–∞—Å—Ç–∞–≤—å –±–∞—Å '—Å–∫–æ–ª—å–∑–∏—Ç—å' (Glide/Slide) –º–∏–Ω–∏–º—É–º –Ω–∞ –æ–∫—Ç–∞–≤—É –≤–≤–µ—Ä—Ö üé¢"
]

FREESTYLE_WORDS = [
    "–ë–∞—Å", "–°—Ç—É–¥–∏—è", "–î–µ–¥–ª–∞–π–Ω", "–ì–æ—Ä–æ–¥", "–¢–µ–Ω—å", "–≠–∫—Ä–∞–Ω", "–®—É–º", "–†–∏—Ç–º", "–ü—Ä–æ–≤–æ–¥", 
    "–°–≤–µ—Ç", "–í–∏–∑—É–∞–ª", "–ü—Ä–æ–µ–∫—Ç", "–•–æ–ª–æ–¥", "–°–∫–æ—Ä–æ—Å—Ç—å", "–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä", "–ú–∞—Ç—Ä–∏—Ü–∞", "–ö–æ–¥", 
    "–°—Ç–∏–ª—å", "–ú–∏–∫—Ä–æ—Ñ–æ–Ω", "–ù–æ—á—å", "–î–æ–∂–¥—å", "–ü—É–ª—å—Å", "–ò—Å–∫—Ä–∞", "–î–≤–∏–∂", "–°—Ü–µ–Ω–∞", "–°—Ö–µ–º–∞", 
    "–ì–ª–∏—Ç—á", "–ë–∏—Ç", "–≠—Ö–æ", "–¢—Ä–∞—Å—Å–∞", "–ü–µ–ø–µ–ª", "–§–ª–æ—É", "–¢–æ–ª–ø–∞", "–ö–∞–¥—Ä—ã", "–°–æ–Ω", 
    "–ö–æ–Ω–Ω–µ–∫—Ç", "–ö–ª—é—á", "–ó–∞–º–æ–∫", "–û–≥–æ–Ω—å", "–ó–µ—Ä–∫–∞–ª–æ", "–°–∏–≥–Ω–∞–ª", "–ß–∞—Å—Ç–æ—Ç–∞", "–ù–µ–π—Ä–æ—Å–µ—Ç—å", 
    "–ë–ª–æ–∫", "–ú–∞–π–∫", "–£–ª–∏—Ü–∞", "–ì–æ–ª–æ—Å", "–ü–∞–º—è—Ç—å", "–°–ª–µ–¥", "–í—Ä–µ–º—è", "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä", "–°—ç–º–ø–ª", 
    "–ü–µ—Ç–ª—è", "–£–¥–∞—Ä", "–í–∞–π–±", "–°–∏–Ω–¥–∏–∫–∞—Ç", "–ö–≤–∞—Ä—Ç–∞–ª", "–†–∞–π–æ–Ω", "–°—Ç–≤–æ–ª", "–î—ã–º", "–ú–æ–Ω–∏—Ç–æ—Ä", 
    "–°–µ–∫–≤–µ–Ω—Å–æ—Ä", "–ü–ª–∞–≥–∏–Ω", "–ú–∞—Å—Ç–µ—Ä–∏–Ω–≥", "–ó–∞–ø–∏—Å—å", "–°–≤–µ–¥–µ–Ω–∏–µ", "–†–µ–≤–µ—Ä–±", "–î–∏–ª–µ–π", "–ê–∫–∫–æ—Ä–¥", 
    "–ù–æ—Ç–∞", "–ü–∏–∫", "–ì–ª—É–±–∏–Ω–∞", "–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ", "–ú–µ—Ç—Ä–æ", "–ê–Ω–¥–µ–≥—Ä–∞—É–Ω–¥", "–ù–µ–æ–Ω", "–ü—Ä–æ–∂–µ–∫—Ç–æ—Ä", 
    "–ë–µ—Ç–æ–Ω", "–ö—Ä—ã—à–∞", "–ê—Å—Ñ–∞–ª—å—Ç", "–ü–æ–¥–≤–∞–ª", "–ö–∞–±–µ–ª—å", "–¢–æ–∫", "–ó–∞–º—ã–∫–∞–Ω–∏–µ", "–ò–º–ø—É–ª—å—Å", 
    "–°–∏–Ω—Ç–µ–∑", "–°–∞–π–¥—á–µ–π–Ω", "–í–æ–∫–∞–ª", "–•—É–∫", "–ö—É–ø–ª–µ—Ç", "–ü–∞–Ω—á", "–†–∏—Ñ–º–∞", "–°–º—ã—Å–ª", "–°–ª–æ–≤–æ", 
    "–¢–µ–∫—Å—Ç", "–ë—É–º–∞–≥–∞", "–ö–∞—Ä–∞–Ω–¥–∞—à", "–¢–µ–ª–µ—Ñ–æ–Ω", "–î–∏–Ω–∞–º–∏–∫", "–ú–µ–º–±—Ä–∞–Ω–∞", "–ö–ª—É–±", "–¢—É—Å–∞", 
    "–ó—Ä–∏—Ç–µ–ª—å", "–ö–∞–ø—é—à–æ–Ω", "–ö—Ä–æ—Å—Å–æ–≤–∫–∏", "–®–∞–≥", "–†–∏—Ç–º–∏–∫–∞", "–¢–µ–º–ø", "–î—Ä–∞–º–∫–∞", "–ö–∏–∫", "–°–Ω—ç–π—Ä", 
    "–•—ç—Ç", "–¢–∞—Ä–µ–ª–∫–∞", "–ñ–µ–ª–µ–∑–æ", "–ú–µ–¥—å", "–°—Ç–∞–ª—å", "–õ–µ–∑–≤–∏–µ", "–†–∞–Ω–∞", "–®—Ä–∞–º", "–ü—É—Ç—å", "–î–æ—Ä–æ–≥–∞", 
    "–ó–Ω–∞–∫", "–°–≤–µ—Ç–æ—Ñ–æ—Ä", "–ü–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫", "–î–≤–∏–∂–µ–Ω–∏–µ", "–¢—Ä–∞—Ñ–∏–∫", "–ì–æ–Ω–∫–∞", "–ú–æ—Ç–æ—Ä", "–î–≤–∏–≥–∞—Ç–µ–ª—å", 
    "–í—ã—Ö–ª–æ–ø", "–ë–µ–Ω–∑–∏–Ω", "–ü–ª–∞–º—è", "–ö–æ—Å—Ç–µ—Ä", "–£–≥–æ–ª—å", "–ü—ã–ª—å", "–ì—Ä—è–∑—å", "–°–Ω–µ–≥", "–õ–µ–¥", "–í–µ—Ç–µ—Ä", 
    "–ë—É—Ä—è", "–®—Ç–æ—Ä–º", "–ì—Ä–æ–º", "–ú–æ–ª–Ω–∏—è", "–ö—Ä–∏–∑–∏—Å", "–°–∏—Å—Ç–µ–º–∞", "–í–∑–ª–æ–º", "–î–æ—Å—Ç—É–ø", "–ü–∞—Ä–æ–ª—å"
]

CONCEPT_ROLES = [
    "–∫–∞–º–µ—Ä—ã –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è üìπ", "–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –ó–µ–º–ª–µ üåç", "—Ö–∞–∫–µ—Ä–∞, –≤–∑–ª–æ–º–∞–≤—à–µ–≥–æ –º–∞—Ç—Ä–∏—Ü—É üíª", 
    "—É–ª–∏—á–Ω–æ–≥–æ –∫–æ—Ç–∞ üêà", "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, –æ–±—Ä–µ—Ç—à–µ–≥–æ —á—É–≤—Å—Ç–≤–∞ ü§ñ", "—Ç–µ–Ω–∏ üë§", 
    "–∑–∞–±—ã—Ç–æ–≥–æ –≤—Å–µ–º–∏ –º—É–∑—ã–∫–∞–Ω—Ç–∞ üé∏", "–∫–∏–ª–ª–µ—Ä–∞ –Ω–∞ –ø–µ–Ω—Å–∏–∏ üíº", "–ø—Ä–∏–∑—Ä–∞–∫–∞ —Å—Ç–∞—Ä–æ–π —Å—Ç—É–¥–∏–∏ üëª"
]

CONCEPT_LOCATIONS = [
    "–≤ –Ω–æ—á–Ω–æ–º –º–µ—Ç—Ä–æ üöá", "–Ω–∞ –∫—Ä—ã—à–µ –Ω–µ–±–æ—Å–∫—Ä–µ–±–∞ –ø–æ–¥ –¥–æ–∂–¥–µ–º üèô", "–≤ –∑–∞–±—Ä–æ—à–µ–Ω–Ω–æ–π —Å—Ç—É–¥–∏–∏ üéõ", 
    "–≤ –∫–∏–±–µ—Ä–ø–∞–Ω–∫-–≥–æ—Ä–æ–¥–µ üåÉ", "–≤ —Å–ø–∞–ª—å–Ω–æ–º —Ä–∞–π–æ–Ω–µ –∑–∏–º–æ–π ‚ùÑÔ∏è", "–≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø—É—Å—Ç–æ—Ç–µ üåå", 
    "–Ω–∞ –∑–∞–¥–Ω–µ–º —Å–∏–¥–µ–Ω—å–µ —Ç–∞–∫—Å–∏ üöï"
]

CONCEPT_TOPICS = [
    "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–æ–≤–æ–¥–∞ üîå", "–æ–∫–µ–∞–Ω –∏ –≥–ª—É–±–∏–Ω–∞ üåä", "–æ—Ä—É–∂–∏–µ –∏ –∫—Ä–∏–º–∏–Ω–∞–ª üî™", 
    "–≤—Ä–µ–º—è –∏ —á–∞—Å—ã ‚è≥", "–∫–æ—Å–º–æ—Å –∏ –∑–≤–µ–∑–¥—ã ‚ú®", "—Ö–æ–ª–æ–¥ –∏ –ª–µ–¥ üßä", 
    "–∞–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã –∏ —Ä–∏—Å–∫ üé≤", "–∏–ª–ª—é–∑–∏–∏ –∏ —Å–Ω—ã üí≠"
]

PRO_TIPS = [
    "<b>–°–∞—Ç—É—Ä–∞—Ü–∏—è 808-–≥–æ:</b> –ß—Ç–æ–±—ã –±–∞—Å –∑–≤—É—á–∞–ª –ø–ª–æ—Ç–Ω–µ–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö, –¥–æ–±–∞–≤—å –Ω–∞ –Ω–µ–≥–æ –ª–µ–≥–∫–∏–π —Å–∞—Ç—É—Ä–∞—Ç–æ—Ä (Distortion) –Ω–∞ —Å—Ä–µ–¥–Ω–∏—Ö —á–∞—Å—Ç–æ—Ç–∞—Ö (400-800 –ì—Ü).",
    "<b>–°—Ä–µ–∑ —Å–∞–±-–Ω–∏–∑–∞:</b> –ü–æ–ø—Ä–æ–±—É–π —Å—Ä–µ–∑–∞—Ç—å —ç–∫–≤–∞–ª–∞–π–∑–µ—Ä–æ–º —á–∞—Å—Ç–æ—Ç—ã –Ω–∏–∂–µ 30 –ì—Ü –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ. –¢—ã –∏—Ö –ø–æ—á—Ç–∏ –Ω–µ —Å–ª—ã—à–∏—à—å, –Ω–æ –æ–Ω–∏ —Å—ä–µ–¥–∞—é—Ç –∫—É—á—É –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (Headroom).",
    "<b>–ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π–¥—á–µ–π–Ω:</b> –°–∞–π–¥—á–µ–π–Ω –º–æ–∂–Ω–æ –≤–µ—à–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –±–∞—Å! –ü–æ–ø—Ä–æ–±—É–π –∑–∞—Å–∞–π–¥—á–µ–π–Ω–∏—Ç—å —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—é –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤–æ–∫–∞–ª–∞.",
    "<b>–•—å—é–º–∞–Ω–∏–∑–∞—Ü–∏—è (Humanize):</b> –°–¥–≤–∏–Ω—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–æ—Ç—ã —á—É—Ç—å-—á—É—Ç—å –º–∏–º–æ —Å–µ—Ç–∫–∏. –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –∂–∏–≤–æ–≥–æ –≥—Ä—É–≤–∞.",
    "<b>–ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö—ç—Ç–æ–≤:</b> –ò—Å–ø–æ–ª—å–∑—É–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –ø–∞–Ω–æ—Ä–∞–º—ã –Ω–∞ —Ö–∞–π-—Ö—ç—Ç–∞—Ö. –≠—Ç–æ —Ä–∞—Å—à–∏—Ä–∏—Ç –º–∏–∫—Å.",
    "<b>–õ–µ–π–µ—Ä–∏–Ω–≥ —Å–Ω–µ–π—Ä–æ–≤:</b> –°–∫–ª–µ–π –¥–≤–∞ —Å–Ω–µ–π—Ä–∞: –æ–¥–∏–Ω —Ö–ª–µ—Å—Ç–∫–∏–π, –¥—Ä—É–≥–æ–π —Å —Ç–µ–ª–æ–º.",
    "<b>–ü–∞—É–∑—ã —Ä–µ—à–∞—é—Ç:</b> –°–¥–µ–ª–∞–π —Ä–µ–∑–∫—É—é –ø–∞—É–∑—É –ø–µ—Ä–µ–¥ –¥—Ä–æ–ø–æ–º ‚Äî —ç—Ç–æ —É—Å–∏–ª–∏—Ç —É–¥–∞—Ä –≤ 10 —Ä–∞–∑."
]

# ==========================================
# 4. –ù–ê–°–¢–†–û–ô–ö–ê –î–ò–°–ü–ï–¢–ß–ï–†–ê –ò –ö–õ–ê–í–ò–ê–¢–£–†
# ==========================================
dp = Dispatcher()

def get_main_keyboard():
    kb = [
        # –î–û–ë–ê–í–õ–ï–ù–ê –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –î–õ–Ø WEB APP –ù–ê –°–ê–ú–´–ô –í–ï–†–•
        [KeyboardButton(text="üì± –û—Ç–∫—Ä—ã—Ç—å Web App", web_app=WebAppInfo(url=WEB_APP_URL))],
        [KeyboardButton(text="/challenge"), KeyboardButton(text="/freestyle")],
        [KeyboardButton(text="/concept"), KeyboardButton(text="/tip")],
        [KeyboardButton(text="/stats"), KeyboardButton(text="/settings")]
    ]
    return ReplyKeyboardMarkup(keyboard=kb, resize_keyboard=True)

def get_settings_keyboard():
    kb = [
        [InlineKeyboardButton(text="–•–∞—Ä–¥–∫–æ—Ä (3 —Å–µ–∫)", callback_data="interval_3")],
        [InlineKeyboardButton(text="–ù–æ—Ä–º–∞–ª (5 —Å–µ–∫)", callback_data="interval_5")],
        [InlineKeyboardButton(text="–ß–∏–ª–ª (10 —Å–µ–∫)", callback_data="interval_10")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=kb)

def get_reroll_keyboard(action: str):
    kb = [[InlineKeyboardButton(text="üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π", callback_data=f"reroll_{action}")]]
    return InlineKeyboardMarkup(inline_keyboard=kb)

# ==========================================
# 5. –õ–û–ì–ò–ö–ê –ë–û–¢–ê
# ==========================================

@dp.message(Command("start", "help"))
async def command_start_handler(message: types.Message) -> None:
    get_user(message.from_user.id)
    text = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π –∏ —Ç—Ä–µ–Ω–∞–∂–µ—Ä. üéß\n\n"
        "üî• <b>–¢–µ–ø–µ—Ä—å —É –º–µ–Ω—è –µ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ! –ñ–º–∏ –∫–Ω–æ–ø–∫—É ¬´üì± –û—Ç–∫—Ä—ã—Ç—å Web App¬ª –≤–Ω–∏–∑—É.</b>\n\n"
        "–õ–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–π –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "üéπ /challenge - –ò–¥–µ—è –¥–ª—è –±–∏—Ç–∞\n"
        "üé§ /freestyle - –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ñ–ª–æ—É\n"
        "üìù /concept - –°—é–∂–µ—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞\n"
        "üí° /tip - –°–æ–≤–µ—Ç –ø–æ —Å–≤–µ–¥–µ–Ω–∏—é\n"
        "üìä /stats - –¢–≤–æ–π —Ä–∞–Ω–≥\n"
        "‚öôÔ∏è /settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∏"
    )
    await message.answer(text, reply_markup=get_main_keyboard(), parse_mode="HTML")

def generate_challenge_text():
    bpm = random.randint(120, 160) 
    genre = random.choice(GENRES)
    mood = random.choice(MOODS)
    instrument = random.choice(INSTRUMENTS)
    
    num_conditions = random.randint(2, 3)
    selected_conditions = random.sample(CONDITIONS, num_conditions)
    conditions_text = "\n".join([f"üî∏ {c}" for c in selected_conditions])

    return (
        "üî• <b>–¢–≤–æ–π —Å–ª–æ–∂–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂:</b>\n\n"
        f"<b>–ñ–∞–Ω—Ä:</b> {genre}\n"
        f"<b>–¢–µ–º–ø:</b> {bpm} BPM\n"
        f"<b>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</b> {mood}\n"
        f"<b>–ì–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:</b> {instrument}\n\n"
        f"<b>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:</b>\n{conditions_text}\n\n"
        "–û—Ç–∫—Ä—ã–≤–∞–π —Å–µ–∫–≤–µ–Ω—Å–æ—Ä –∏ –¥–µ–ª–∞–π –≥—Ä—è–∑—å! üöÄ"
    )

@dp.message(Command("challenge"))
async def challenge_handler(message: types.Message) -> None:
    update_stat(message.from_user.id, "challenges_done", 1)
    await message.answer(generate_challenge_text(), parse_mode="HTML", reply_markup=get_reroll_keyboard("challenge"))

@dp.callback_query(F.data == "reroll_challenge")
async def process_reroll_challenge(callback: types.CallbackQuery):
    try:
        await callback.message.edit_text(generate_challenge_text(), parse_mode="HTML", reply_markup=get_reroll_keyboard("challenge"))
    except:
        pass
    await callback.answer()

@dp.message(Command("freestyle"))
async def freestyle_handler(message: types.Message) -> None:
    user_id = message.from_user.id
    interval = get_user(user_id)["interval"]

    await message.answer(f"üé§ –ü–æ–≥–Ω–∞–ª–∏! 10 —Å–ª–æ–≤. –°–º–µ–Ω–∞ –∫–∞–∂–¥—ã–µ {interval} —Å–µ–∫—É–Ω–¥.\n\n–ì–æ—Ç–æ–≤? 3... 2... 1...")
    await asyncio.sleep(3)

    words_to_use = random.sample(FREESTYLE_WORDS, 10)

    for i, word in enumerate(words_to_use, 1):
        await message.answer(f"üî• –°–ª–æ–≤–æ [{i}/10]: <b>{word}</b>", parse_mode="HTML")
        await asyncio.sleep(interval)

    update_stat(user_id, "words_freestyled", 10)
    rank = get_rank(get_user(user_id)["words"])
    await message.answer(f"–£—Ñ, —ç—Ç–æ –±—ã–ª–æ –≥–æ—Ä—è—á–æ! üëè\n–¢–≤–æ–π —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥: <b>{rank}</b>", parse_mode="HTML")

@dp.message(Command("stats"))
async def stats_handler(message: types.Message) -> None:
    user_data = get_user(message.from_user.id)
    rank = get_rank(user_data["words"])
    
    stats_text = (
        f"üìä <b>–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n\n"
        f"üèÜ <b>–†–∞–Ω–≥:</b> {rank}\n"
        f"üéπ <b>–ü—Ä–∏–Ω—è—Ç–æ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π:</b> {user_data['challenges']} —à—Ç.\n"
        f"üé§ <b>–ó–∞—Ñ—Ä–∏—Å—Ç–∞–π–ª–µ–Ω–æ —Å–ª–æ–≤:</b> {user_data['words']} —à—Ç.\n"
        f"‚è± <b>–¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ñ—Ä–∏—Å—Ç–∞–π–ª–∞:</b> {user_data['interval']} —Å–µ–∫."
    )
    await message.answer(stats_text, parse_mode="HTML")

def generate_concept_text():
    role = random.choice(CONCEPT_ROLES)
    location = random.choice(CONCEPT_LOCATIONS)
    topic = random.choice(CONCEPT_TOPICS)
    
    return (
        "üìù <b>–ö–æ–Ω—Ü–µ–ø—Ç –¥–ª—è —Ç–≤–æ–µ–≥–æ –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:</b>\n\n"
        f"üé≠ <b>–û—Ç –ª–∏—Ü–∞:</b> {role}\n"
        f"üìç <b>–õ–æ–∫–∞—Ü–∏—è:</b> {location}\n"
        f"üß† <b>–ì–ª–∞–≤–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã:</b> {topic}"
    )

@dp.message(Command("concept"))
async def concept_handler(message: types.Message) -> None:
    await message.answer(generate_concept_text(), parse_mode="HTML", reply_markup=get_reroll_keyboard("concept"))

@dp.callback_query(F.data == "reroll_concept")
async def process_reroll_concept(callback: types.CallbackQuery):
    try:
        await callback.message.edit_text(generate_concept_text(), parse_mode="HTML", reply_markup=get_reroll_keyboard("concept"))
    except:
        pass
    await callback.answer()

@dp.message(Command("tip"))
async def tip_handler(message: types.Message) -> None:
    await message.answer(f"üí° <b>–ü—Ä–æ–¥—é—Å–µ—Ä—Å–∫–∞—è –º—É–¥—Ä–æ—Å—Ç—å:</b>\n\n{random.choice(PRO_TIPS)}", parse_mode="HTML")

@dp.message(Command("settings"))
async def settings_handler(message: types.Message) -> None:
    await message.answer("‚öôÔ∏è –í—ã–±–µ—Ä–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–º–µ–Ω—ã —Å–ª–æ–≤ –¥–ª—è —Ñ—Ä–∏—Å—Ç–∞–π–ª–∞:", reply_markup=get_settings_keyboard())

@dp.callback_query(F.data.startswith("interval_"))
async def process_interval_setting(callback: types.CallbackQuery):
    new_interval = int(callback.data.split("_")[1])
    set_interval(callback.fromuser.id if hasattr(callback, 'from_user') else callback.from_user.id, new_interval)
    await callback.message.edit_text(f"‚úÖ –ì–æ—Ç–æ–≤–æ! –°–ª–æ–≤–∞ –≤–æ —Ñ—Ä–∏—Å—Ç–∞–π–ª–µ –±—É–¥—É—Ç –º–µ–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ <b>{new_interval} —Å–µ–∫—É–Ω–¥</b>.", parse_mode="HTML")
    await callback.answer()

# ==========================================
# 6. –ó–ê–ü–£–°–ö –ë–û–¢–ê
# ==========================================
async def main() -> None:
    init_db()
    bot = Bot(token=TOKEN)
    print("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω! –û—Ç–∫—Ä–æ–π Telegram –∏ –Ω–∞–ø–∏—à–∏ –µ–º—É /start")
    await dp.start_polling(bot)

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, stream=sys.stdout)
    asyncio.run(main())
